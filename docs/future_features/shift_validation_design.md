# 班別驗證與異常過濾功能 - 設計方案

> **狀態**: 待開發  
> **建立日期**: 2025-12-07  
> **目的**: 根據組別規則自動驗證打卡記錄，識別異常情況

---

## 📋 需求概述

### 核心需求

1. **多組別彈性規則**
   - 不同組別有不同的上班時間（例如：清運班 06:00、地勤班 08:00、隊部 12:30）
   - 每個組別可能有不同的段數（2段班、3段班等）

2. **加班機制**
   - 提前加班：例如 08:00 上班但 06:00 開始工作（加班 2 小時）
   - 延後加班：正常下班後繼續工作
   - 加班倍率計算（如 1.33、1.66 倍）

3. **打卡驗證**
   - 每段班需在規定時間範圍內打卡
   - 每段班需滿足最少工時要求（通常 4 小時）
   - 區分必填段別和選填段別（加班）

4. **異常過濾**
   - 缺少必填段別
   - 工時不足
   - 打卡時間不在規定範圍
   - 段別不完整（只打上班或下班）

---

## 🗂️ 資料結構設計

### Excel 規則表：`data/班別規則.xlsx`

| 組別 | 班別 | 段別 | 類型 | 開始時間 | 結束時間 | 最少工時 | 是否加班 | 加班倍率 | 備註 |
|------|------|------|------|---------|---------|---------|---------|---------|------|
| 清運班 | 日班 | 第一段 | 必填 | 06:00 | 06:30 | 4 | 否 | 1.0 | 早班 |
| 清運班 | 日班 | 第二段 | 必填 | 10:30 | 11:00 | 4 | 否 | 1.0 | |
| 地勤一班 | 日班 | 加班段 | 選填 | 06:00 | 06:30 | 2 | 是 | 1.33 | 提前加班 |
| 地勤一班 | 日班 | 第一段 | 必填 | 08:00 | 08:30 | 4 | 否 | 1.0 | |
| 地勤一班 | 日班 | 第二段 | 必填 | 13:00 | 13:30 | 4 | 否 | 1.0 | |
| 地勤一班 | 日班 | 第三段 | 選填 | 18:00 | 18:30 | 2 | 是 | 1.33 | 延後加班 |
| 隊部 | 日班 | 第一段 | 必填 | 12:30 | 13:00 | 4 | 否 | 1.0 | |
| 隊部 | 日班 | 第二段 | 必填 | 17:30 | 18:00 | 4 | 否 | 1.0 | |

**欄位說明**：
- **類型**: `必填` = 正常班次，`選填` = 通常是加班
- **是否加班**: 用於工時統計和薪資計算
- **加班倍率**: 加班費計算倍數

---

## 🏗️ 架構設計

### 模組結構

```
services/
├── shift_rule_manager.py      # 規則管理器（從 Excel 載入）
├── shift_validator.py          # 班別驗證器
└── anomaly_filter.py           # 異常過濾器

data/
└── 班別規則.xlsx               # 規則表（由管理者維護）
```

### 處理流程

```
1. 載入規則表 (ShiftRuleManager)
   ↓
2. 讀取打卡資料
   ↓
3. 根據組別選擇對應規則 (ShiftValidator)
   ↓
4. 驗證每個段別
   ↓
5. 計算工時（正常 + 加班）
   ↓
6. 過濾異常 (AnomalyFilter)
   ↓
7. 生成報表
```

---

## 💻 核心程式碼設計

### 1. 規則管理器

```python
# services/shift_rule_manager.py
class ShiftRuleManager:
    """從 Excel 載入並管理班別規則"""
    
    def __init__(self, rule_file: str = 'data/班別規則.xlsx'):
        self.rules = {}
        self._load_rules_from_excel(rule_file)
    
    def get_rules(self, group: str, shift: str) -> Dict:
        """取得特定組別的規則"""
        return self.rules.get(group, {}).get(shift, {})
    
    def get_required_segments(self, group: str, shift: str) -> Dict:
        """取得必填段別"""
        segments = self.get_rules(group, shift)
        return {k: v for k, v in segments.items() if v['類型'] == '必填'}
    
    def get_optional_segments(self, group: str, shift: str) -> Dict:
        """取得選填段別（加班）"""
        segments = self.get_rules(group, shift)
        return {k: v for k, v in segments.items() if v['類型'] == '選填'}
```

### 2. 班別驗證器

```python
# services/shift_validator.py
class ShiftValidator:
    """驗證打卡是否符合班別規則"""
    
    def validate_punch_times(self, punch_times: List[str]) -> Dict:
        """
        驗證打卡時間
        
        Returns:
            {
                'valid': bool,
                'segments': {
                    '第一段': {'valid': True, 'duration_hours': 4.5, ...},
                    '加班段': {'valid': True, 'duration_hours': 2.0, ...}
                },
                'summary': {
                    '正常工時': 8.0,
                    '加班工時': 2.0,
                    '總工時': 10.0,
                    '加班費': 2.66  # 2 * 1.33
                }
            }
        """
        pass
```

### 3. 異常過濾器

```python
# services/anomaly_filter.py
class AnomalyFilter:
    """過濾打卡異常"""
    
    ANOMALY_TYPES = {
        'MISSING_REQUIRED': '缺少必填段別',
        'INSUFFICIENT_HOURS': '工時不足',
        'WRONG_TIME': '打卡時間不在規定範圍',
        'INCOMPLETE_SEGMENT': '段別不完整',
    }
    
    def filter_anomalies(self, punch_data: pd.DataFrame, 
                        anomaly_types: List[str] = None) -> pd.DataFrame:
        """
        過濾異常打卡
        
        Args:
            punch_data: 打卡資料
            anomaly_types: 要過濾的異常類型
        
        Returns:
            只包含異常記錄的 DataFrame
        """
        pass
```

---

## 🎯 使用情境範例

### 情境 1：正常兩段班

**地勤一班，正常上班**

打卡時間：`08:15, 12:00, 13:00, 17:00`

驗證結果：
```
✓ 符合規則
- 第一段：08:15-12:00 (3.75小時) → ✓
- 第二段：13:00-17:00 (4.0小時) → ✓
正常工時：7.75小時
```

### 情境 2：提前加班

**地勤一班，提前 2 小時加班**

打卡時間：`06:00, 12:00, 13:00, 17:00`

驗證結果：
```
✓ 符合規則
- 加班段：06:00-12:00 (6小時，取最少2小時) → ✓
- 第一段：已包含在上午時段
- 第二段：13:00-17:00 (4.0小時) → ✓
正常工時：4小時
加班工時：2小時 (倍率 1.33)
加班費：2.66小時
```

### 情境 3：異常打卡

**隊部，第二段工時不足**

打卡時間：`12:45, 17:00, 17:30, 20:00`

驗證結果：
```
✗ 不符合規則
- 第一段：12:45-17:00 (4.25小時) → ✓
- 第二段：17:30-20:00 (2.5小時) → ✗ 工時不足（需4小時）

異常類型：INSUFFICIENT_HOURS
詳細說明：第二段: 工時不足 2.5 < 4.0
```

---

## 🖥️ GUI 界面設計

### 異常過濾界面

```
┌─────────────────────────────────────────┐
│  打卡異常過濾                            │
├─────────────────────────────────────────┤
│  選擇日期：[2025-12-07] [日曆]          │
│                                          │
│  異常類型：                              │
│  ☑ 缺少必填段別                         │
│  ☑ 工時不足                             │
│  ☑ 打卡時間錯誤                         │
│  ☑ 段別不完整                           │
│                                          │
│  [查詢異常] [匯出 Excel]                │
│                                          │
│  ⚠ 發現 3 筆異常                        │
│  ┌────────────────────────────────────┐ │
│  │ #1 張三 (A001) - 清運班            │ │
│  │   異常: 第二段工時不足             │ │
│  │                                    │ │
│  │ #2 李四 (B002) - 地勤一班          │ │
│  │   異常: 未在規定時間打第一段卡     │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 📊 報表輸出範例

### 異常打卡報表 Excel

| 日期 | 公務帳號 | 姓名 | 組別 | 異常類型 | 詳細說明 | 打卡時間 |
|------|---------|------|------|---------|---------|---------|
| 2025-12-07 | A001 | 張三 | 清運班 | 工時不足 | 第二段: 工時不足 2.5 < 4.0 | 06:00, 10:00, 10:30, 13:00 |
| 2025-12-07 | B002 | 李四 | 地勤一班 | 打卡時間錯誤 | 第一段: 未在 08:00-08:30 打卡 | 09:00, 13:00, 13:30, 17:30 |

---

## ⚠️ 待確認需求

### 需與使用者確認的項目

1. **規則表維護**
   - [ ] 由誰負責維護 `班別規則.xlsx`？
   - [ ] 規則變更頻率？
   - [ ] 是否需要規則版本控制？

2. **加班認定**
   - [ ] 加班是否需要事前申請/審核？
   - [ ] 如何區分「忘記打卡」和「真的加班」？
   - [ ] 加班倍率是固定的嗎？（平日/假日可能不同）

3. **異常處理**
   - [ ] 發現異常後的處理流程？（通知？人工審核？）
   - [ ] 是否需要「異常忽略」功能？（特殊情況豁免）
   - [ ] 異常報表的發送對象？

4. **彈性段數**
   - [ ] 最多支援幾段班？
   - [ ] 三段班的工時如何計算？
   - [ ] 是否有「不定段數」的組別？

5. **特殊情況**
   - [ ] 請假/公出如何處理？
   - [ ] 跨日班次（夜班）如何計算？
   - [ ] 國定假日的規則是否不同？

---

## 🚀 實作優先級建議

### Phase 1：基礎功能（必要）
1. 規則表設計與載入
2. 基本兩段班驗證
3. 異常過濾（缺卡、工時不足）

### Phase 2：加班支援（重要）
1. 加班段識別
2. 工時統計（正常+加班）
3. 加班費計算

### Phase 3：進階功能（可選）
1. 彈性段數支援（3段班以上）
2. 異常忽略機制
3. 自動通知功能

---

## 📝 開發檢查清單

- [ ] 確認完整需求
- [ ] 設計規則表格式（與使用者確認）
- [ ] 建立規則範本 Excel
- [ ] 實作 `ShiftRuleManager`
- [ ] 實作 `ShiftValidator`
- [ ] 實作 `AnomalyFilter`
- [ ] 撰寫單元測試
- [ ] 整合 GUI 界面
- [ ] 使用者驗收測試
- [ ] 撰寫使用手冊

---

## 💡 技術考量

### 優勢
- **規則驅動**：修改規則不需改程式碼
- **可測試**：每個模組可獨立測試
- **可擴展**：新增組別只需加 Excel 資料

### 風險
- **規則複雜度**：規則過於複雜可能難以維護
- **效能**：大量資料驗證可能較慢（可優化）
- **使用者訓練**：需要教育使用者如何維護規則表

### 建議
1. 先從簡單規則開始，逐步擴充
2. 提供規則驗證工具（檢查規則表是否正確）
3. 建立詳細的使用手冊和範例

---

**最後更新**: 2025-12-07  
**待討論完整需求後再進行開發**
