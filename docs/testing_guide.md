# æ¨¡çµ„æ¸¬è©¦æŒ‡å—

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•é€²è¡Œæ¨¡çµ„ç¨ç«‹æ¸¬è©¦ï¼Œè®“æœªä¾†æ¥æ‰‹çš„é–‹ç™¼è€…èƒ½å¿«é€Ÿç†è§£æ¸¬è©¦æ¶æ§‹ã€‚

## ğŸ“š ç›®éŒ„

- [ä»€éº¼æ˜¯æ¨¡çµ„ç¨ç«‹æ¸¬è©¦](#ä»€éº¼æ˜¯æ¨¡çµ„ç¨ç«‹æ¸¬è©¦)
- [æ¸¬è©¦çš„ç›®æ¨™](#æ¸¬è©¦çš„ç›®æ¨™)
- [æ¸¬è©¦ç’°å¢ƒè¨­ç½®](#æ¸¬è©¦ç’°å¢ƒè¨­ç½®)
- [æ¸¬è©¦ç¯„ä¾‹](#æ¸¬è©¦ç¯„ä¾‹)
- [åŸ·è¡Œæ¸¬è©¦](#åŸ·è¡Œæ¸¬è©¦)
- [æ¸¬è©¦é©…å‹•é–‹ç™¼](#æ¸¬è©¦é©…å‹•é–‹ç™¼)
- [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## ä»€éº¼æ˜¯æ¨¡çµ„ç¨ç«‹æ¸¬è©¦

### å‚³çµ±æ•´åˆæ¸¬è©¦ vs æ¨¡çµ„ç¨ç«‹æ¸¬è©¦

**å‚³çµ±æ•´åˆæ¸¬è©¦**ï¼š
```
åŸ·è¡Œæ•´å€‹ç¨‹å¼ â†’ è®€å– Excel â†’ è½‰æ› â†’ é©—è­‰ â†’ è¼‰å…¥ â†’ ç”Ÿæˆå ±è¡¨
âŒ å¦‚æœå¤±æ•—ï¼Œä¸çŸ¥é“å“ªå€‹ç’°ç¯€å‡ºéŒ¯
âŒ éœ€è¦æº–å‚™å®Œæ•´çš„æ¸¬è©¦è³‡æ–™
âŒ åŸ·è¡Œæ™‚é–“é•·
```

**æ¨¡çµ„ç¨ç«‹æ¸¬è©¦ï¼ˆå–®å…ƒæ¸¬è©¦ï¼‰**ï¼š
```
åªæ¸¬è©¦è³‡æ–™æ¨¡å‹ âœ“       (ä¸éœ€è¦ Excel)
åªæ¸¬è©¦é©—è­‰å™¨ âœ“         (ç”¨å‡è³‡æ–™)
åªæ¸¬è©¦è®€å–å™¨ âœ“         (ç”¨å°æ¸¬è©¦æª”)
âœ… æ˜ç¢ºçŸ¥é“æ¯å€‹æ¨¡çµ„çš„è¡Œç‚º
âœ… å¿«é€ŸåŸ·è¡Œï¼ˆç§’ç´šï¼‰
âœ… å•é¡Œå®šä½ç²¾ç¢º
```

---

## æ¸¬è©¦çš„ç›®æ¨™

| ç›®æ¨™ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| **é©—è­‰æ­£ç¢ºæ€§** | åŠŸèƒ½æ˜¯å¦æŒ‰é æœŸå·¥ä½œ | æ°‘åœ‹å¹´ `1121201` æ‡‰è½‰ç‚º `2023-12-01` |
| **å›æ­¸æ¸¬è©¦** | ä¿®æ”¹å¾Œæ²’æœ‰ç ´å£åŸæœ‰åŠŸèƒ½ | æ”¹äº† A æ¨¡çµ„ï¼Œç¢ºèª B æ¨¡çµ„é‚„èƒ½ç”¨ |
| **é‚Šç•Œæ¢ä»¶** | æ¥µç«¯æƒ…æ³çš„è™•ç† | ç©ºå­—ä¸²ã€è¶…å¤§æ•¸å­—ã€ç‰¹æ®Šå­—å…ƒ |
| **éŒ¯èª¤è™•ç†** | éŒ¯èª¤è¨Šæ¯æ˜¯å¦æ¸…æ¥š | ç©ºå¸³è™Ÿæ‡‰é¡¯ç¤ºã€Œå…¬å‹™å¸³è™Ÿä¸å¯ç‚ºç©ºã€ |
| **æ–‡ä»¶ä½œç”¨** | æ¸¬è©¦å³æ–‡ä»¶ | çœ‹æ¸¬è©¦å°±çŸ¥é“åŠŸèƒ½æ€éº¼ç”¨ |

---

## æ¸¬è©¦ç’°å¢ƒè¨­ç½®

### å®‰è£æ¸¬è©¦ä¾è³´

```bash
# å·²åŒ…å«åœ¨ requirements.txt ä¸­
pip install -r requirements.txt
```

### æª”æ¡ˆçµæ§‹

```
tests/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_models.py      # æ¸¬è©¦è³‡æ–™æ¨¡å‹
â”œâ”€â”€ test_validators.py  # æ¸¬è©¦é©—è­‰å™¨
â”œâ”€â”€ test_readers.py     # æ¸¬è©¦è®€å–å™¨
â””â”€â”€ test_pipeline.py    # æ¸¬è©¦ ETL ç®¡é“
```

---

## æ¸¬è©¦ç¯„ä¾‹

### 1. æ¸¬è©¦è³‡æ–™æ¨¡å‹ï¼ˆcore/models.pyï¼‰

**ç›®æ¨™**ï¼šé©—è­‰è³‡æ–™è½‰æ›é‚è¼¯

```python
# tests/test_models.py
import unittest
from core.models import PunchRecord
from datetime import date, time

class TestPunchRecord(unittest.TestCase):
    """æ¸¬è©¦æ‰“å¡è¨˜éŒ„æ¨¡å‹"""
    
    def test_æ°‘åœ‹å¹´è½‰æ›(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰æ°‘åœ‹å¹´èƒ½æ­£ç¢ºè½‰ç‚ºè¥¿å…ƒå¹´
        è¼¸å…¥ï¼š1121201 (æ°‘åœ‹112å¹´12æœˆ01æ—¥)
        é æœŸï¼š2023-12-01
        """
        data = {
            'å…¬å‹™å¸³è™Ÿ': 'EMP001',
            'åˆ·å¡æ—¥æœŸ': '1121201',
            'åˆ·å¡æ™‚é–“': '0830'
        }
        
        record = PunchRecord(**data)
        
        # é©—è­‰çµæœ
        self.assertEqual(record.åˆ·å¡æ—¥æœŸ, date(2023, 12, 1))
        self.assertEqual(record.å…¬å‹™å¸³è™Ÿ, 'EMP001')
    
    def test_4ä½æ•¸æ™‚é–“è½‰æ›(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰ 4 ä½æ•¸æ™‚é–“è½‰ç‚ºæ¨™æº–æ™‚é–“
        è¼¸å…¥ï¼š0830
        é æœŸï¼š08:30:00
        """
        data = {
            'å…¬å‹™å¸³è™Ÿ': 'EMP001',
            'åˆ·å¡æ—¥æœŸ': '2023-12-01',
            'åˆ·å¡æ™‚é–“': '0830'
        }
        
        record = PunchRecord(**data)
        self.assertEqual(record.åˆ·å¡æ™‚é–“, time(8, 30, 0))
    
    def test_ç„¡æ•ˆè³‡æ–™æ‡‰è©²å¤±æ•—(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰éŒ¯èª¤è³‡æ–™æœƒè¢«æ””æˆª
        è¼¸å…¥ï¼šç©ºçš„å…¬å‹™å¸³è™Ÿ
        é æœŸï¼šæ‹‹å‡º ValueError
        """
        with self.assertRaises(ValueError):
            PunchRecord(**{
                'å…¬å‹™å¸³è™Ÿ': '',  # ç©ºå€¼æ‡‰è©²å¤±æ•—
                'åˆ·å¡æ—¥æœŸ': '2023-12-01',
                'åˆ·å¡æ™‚é–“': '08:30:00'
            })
```

### 2. æ¸¬è©¦è³‡æ–™é©—è­‰å™¨ï¼ˆcore/validators.pyï¼‰

**ç›®æ¨™**ï¼šé©—è­‰æ‰¹æ¬¡è³‡æ–™é©—è­‰é‚è¼¯

```python
# tests/test_validators.py
import pandas as pd
from core.validators import DataValidator
from core.models import PunchRecord

class TestDataValidator(unittest.TestCase):
    """æ¸¬è©¦è³‡æ–™é©—è­‰å™¨"""
    
    def test_é©—è­‰æœ‰æ•ˆè³‡æ–™(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šç¢ºèªæœ‰æ•ˆè³‡æ–™èƒ½é€šéé©—è­‰
        """
        # å»ºç«‹æ¸¬è©¦ç”¨ DataFrame
        df = pd.DataFrame([
            {'å…¬å‹™å¸³è™Ÿ': 'A001', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '0830'},
            {'å…¬å‹™å¸³è™Ÿ': 'A002', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '1730'},
        ])
        
        validator = DataValidator(PunchRecord)
        valid_records, result = validator.validate(df)
        
        # é©—è­‰çµæœ
        self.assertEqual(result.valid_count, 2)
        self.assertEqual(result.error_count, 0)
        self.assertTrue(result.success)
    
    def test_é©—è­‰æ··åˆè³‡æ–™(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šç¢ºèªèƒ½æ­£ç¢ºåˆ†é›¢æœ‰æ•ˆå’Œç„¡æ•ˆè³‡æ–™
        """
        df = pd.DataFrame([
            {'å…¬å‹™å¸³è™Ÿ': 'A001', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '0830'},  # æœ‰æ•ˆ
            {'å…¬å‹™å¸³è™Ÿ': '', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '0830'},      # ç„¡æ•ˆ
            {'å…¬å‹™å¸³è™Ÿ': 'A003', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '0900'},  # æœ‰æ•ˆ
        ])
        
        validator = DataValidator(PunchRecord)
        valid_records, result = validator.validate(df)
        
        self.assertEqual(result.valid_count, 2)
        self.assertEqual(result.error_count, 1)
```

### 3. æ¸¬è©¦ ETL ç®¡é“ï¼ˆcore/pipeline.pyï¼‰

**ç›®æ¨™**ï¼šé©—è­‰å®Œæ•´çš„ ETL æµç¨‹

```python
# tests/test_pipeline.py
import tempfile
import pandas as pd
from pathlib import Path
from core.pipeline import ETLPipeline
from core.readers import DataFrameReader
from core.validators import DataValidator
from core.models import PunchRecord

class TestETLPipeline(unittest.TestCase):
    """æ¸¬è©¦ ETL ç®¡é“"""
    
    def setUp(self):
        """æ¯æ¬¡æ¸¬è©¦å‰æº–å‚™æ¸¬è©¦è³‡æ–™"""
        self.test_data = pd.DataFrame([
            {'å…¬å‹™å¸³è™Ÿ': 'T001', 'åˆ·å¡æ—¥æœŸ': '1121201', 'åˆ·å¡æ™‚é–“': '0830'},
            {'å…¬å‹™å¸³è™Ÿ': 'T002', 'åˆ·å¡æ—¥æœŸ': '1121202', 'åˆ·å¡æ™‚é–“': '0900'},
        ])
    
    def test_å®Œæ•´ETLæµç¨‹(self):
        """
        æ¸¬è©¦ç›®æ¨™ï¼šé©—è­‰ Extract â†’ Transform â†’ Validate â†’ Load å®Œæ•´æµç¨‹
        """
        # å»ºç«‹è‡¨æ™‚è³‡æ–™åº«
        with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as tmp:
            db_path = tmp.name
        
        # è¨­å®š ETL ç®¡é“
        reader = DataFrameReader(self.test_data, 'test')
        validator = DataValidator(PunchRecord)
        pipeline = ETLPipeline(reader, validator)
        
        # åŸ·è¡Œ
        result = pipeline.execute(db_path, 'test_table')
        
        # é©—è­‰
        self.assertTrue(result['success'])
        self.assertEqual(result['loaded'], 2)
        
        # æ¸…ç†
        Path(db_path).unlink()
```

---

## åŸ·è¡Œæ¸¬è©¦

### åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨ unittest
cd punch_helper_etl
python -m unittest discover tests/ -v

# æ–¹æ³• 2ï¼šä½¿ç”¨ pytestï¼ˆå¦‚æœ‰å®‰è£ï¼‰
pytest tests/ -v
```

### åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ

```bash
# åªæ¸¬è©¦è³‡æ–™æ¨¡å‹
python -m unittest tests.test_models -v

# åªæ¸¬è©¦é©—è­‰å™¨
python -m unittest tests.test_validators -v
```

### åŸ·è¡Œç‰¹å®šæ¸¬è©¦æ¡ˆä¾‹

```bash
# åªæ¸¬è©¦æ°‘åœ‹å¹´è½‰æ›
python -m unittest tests.test_models.TestPunchRecord.test_æ°‘åœ‹å¹´è½‰æ› -v
```

### è¼¸å‡ºç¯„ä¾‹

```
test_æ°‘åœ‹å¹´è½‰æ› (tests.test_models.TestPunchRecord) ... ok
test_4ä½æ•¸æ™‚é–“è½‰æ› (tests.test_models.TestPunchRecord) ... ok
test_ç„¡æ•ˆè³‡æ–™æ‡‰è©²å¤±æ•— (tests.test_models.TestPunchRecord) ... ok
test_é©—è­‰æœ‰æ•ˆè³‡æ–™ (tests.test_validators.TestDataValidator) ... ok
test_é©—è­‰æ··åˆè³‡æ–™ (tests.test_validators.TestDataValidator) ... ok

----------------------------------------------------------------------
Ran 5 tests in 0.123s

OK
```

---

## æ¸¬è©¦é©…å‹•é–‹ç™¼ï¼ˆTDDï¼‰

### TDD æµç¨‹

```
1. å¯«æ¸¬è©¦ â†’ 2. åŸ·è¡Œï¼ˆå¤±æ•—ï¼‰â†’ 3. å¯«ç¨‹å¼ç¢¼ â†’ 4. åŸ·è¡Œï¼ˆæˆåŠŸï¼‰â†’ 5. é‡æ§‹
```

### å¯¦éš›ç¯„ä¾‹ï¼šæ–°å¢ã€Œéæ¿¾é€±æœ«æ‰“å¡ã€åŠŸèƒ½

#### æ­¥é©Ÿ 1ï¼šå…ˆå¯«æ¸¬è©¦

```python
# tests/test_filters.py
def test_éæ¿¾é€±æœ«æ‰“å¡(self):
    """é€±æœ«çš„æ‰“å¡æ‡‰è©²è¢«éæ¿¾æ‰"""
    df = pd.DataFrame([
        {'æ—¥æœŸ': '2023-12-01', 'å…¬å‹™å¸³è™Ÿ': 'A001'},  # é€±äº”
        {'æ—¥æœŸ': '2023-12-02', 'å…¬å‹™å¸³è™Ÿ': 'A001'},  # é€±å…­
        {'æ—¥æœŸ': '2023-12-03', 'å…¬å‹™å¸³è™Ÿ': 'A001'},  # é€±æ—¥
        {'æ—¥æœŸ': '2023-12-04', 'å…¬å‹™å¸³è™Ÿ': 'A001'},  # é€±ä¸€
    ])
    
    result = filter_weekends(df)
    self.assertEqual(len(result), 2)  # åªå‰©é€±äº”å’Œé€±ä¸€
```

#### æ­¥é©Ÿ 2ï¼šåŸ·è¡Œæ¸¬è©¦ï¼ˆæœƒå¤±æ•—ï¼‰

```bash
$ python -m unittest tests.test_filters
E
======================================================================
ERROR: test_éæ¿¾é€±æœ«æ‰“å¡
----------------------------------------------------------------------
NameError: name 'filter_weekends' is not defined
```

#### æ­¥é©Ÿ 3ï¼šå¯¦ä½œåŠŸèƒ½

```python
# core/filters.py
def filter_weekends(df):
    """éæ¿¾é€±æœ«çš„è³‡æ–™"""
    df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
    df = df[df['æ—¥æœŸ'].dt.dayofweek < 5]  # 0-4 æ˜¯é€±ä¸€åˆ°é€±äº”
    return df
```

#### æ­¥é©Ÿ 4ï¼šå†æ¬¡æ¸¬è©¦ï¼ˆæˆåŠŸï¼‰

```bash
$ python -m unittest tests.test_filters
.
----------------------------------------------------------------------
Ran 1 test in 0.012s

OK
```

---

## å¸¸è¦‹å•é¡Œ

### Q1ï¼šæ¸¬è©¦éœ€è¦çœŸå¯¦çš„ Excel æª”æ¡ˆå—ï¼Ÿ

**A**ï¼šä¸éœ€è¦ï¼é€™å°±æ˜¯æ¨¡çµ„åŒ–æ¸¬è©¦çš„å„ªå‹¢ã€‚

```python
# ä½¿ç”¨ DataFrame æ¨¡æ“¬è³‡æ–™
test_data = pd.DataFrame([...])
reader = DataFrameReader(test_data, 'test')
```

### Q2ï¼šä¿®æ”¹ç¨‹å¼ç¢¼å¾Œéœ€è¦åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦å—ï¼Ÿ

**A**ï¼šå»ºè­°åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ï¼ˆå›æ­¸æ¸¬è©¦ï¼‰ï¼Œç¢ºä¿æ²’æœ‰ç ´å£å…¶ä»–åŠŸèƒ½ã€‚

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦åªéœ€ 1-2 ç§’
python -m unittest discover tests/
```

### Q3ï¼šæ¸¬è©¦å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

**A**ï¼šæ ¹æ“šéŒ¯èª¤è¨Šæ¯å®šä½å•é¡Œ

```
FAIL: test_æ°‘åœ‹å¹´è½‰æ›
AssertionError: datetime.date(2022, 12, 1) != datetime.date(2023, 12, 1)
                ^^^^^^^^                     ^^^^^^^^
                å¯¦éš›çµæœ                      é æœŸçµæœ
```

### Q4ï¼šä»€éº¼æ™‚å€™éœ€è¦å¯«æ¸¬è©¦ï¼Ÿ

**A**ï¼šä»¥ä¸‹æƒ…æ³å»ºè­°å¯«æ¸¬è©¦

- âœ… æ–°å¢åŠŸèƒ½
- âœ… ä¿®å¾© Bug
- âœ… é‡æ§‹ç¨‹å¼ç¢¼
- âœ… è¤‡é›œçš„é‚è¼¯ï¼ˆå¦‚æ—¥æœŸè½‰æ›ï¼‰

---

## æ¸¬è©¦æœ€ä½³å¯¦è¸

### 1. æ¸¬è©¦å‘½åè¦æ¸…æ¥š

```python
# âŒ ä¸å¥½
def test_1(self): ...

# âœ… å¥½
def test_æ°‘åœ‹å¹´è½‰æ›(self): ...
def test_ç„¡æ•ˆè³‡æ–™æ‡‰è©²å¤±æ•—(self): ...
```

### 2. æ¯å€‹æ¸¬è©¦åªæ¸¬è©¦ä¸€ä»¶äº‹

```python
# âŒ ä¸å¥½ï¼šä¸€æ¬¡æ¸¬è©¦å¤ªå¤š
def test_all(self):
    self.assertEqual(...)
    self.assertEqual(...)
    self.assertEqual(...)

# âœ… å¥½ï¼šåˆ†é–‹æ¸¬è©¦
def test_æ—¥æœŸè½‰æ›(self): ...
def test_æ™‚é–“è½‰æ›(self): ...
def test_å¸³è™Ÿé©—è­‰(self): ...
```

### 3. ä½¿ç”¨ setUp å’Œ tearDown

```python
class TestExample(unittest.TestCase):
    def setUp(self):
        """æ¯æ¬¡æ¸¬è©¦å‰åŸ·è¡Œ"""
        self.test_data = pd.DataFrame([...])
    
    def tearDown(self):
        """æ¯æ¬¡æ¸¬è©¦å¾ŒåŸ·è¡Œ"""
        # æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
        pass
```

### 4. æ¸¬è©¦é‚Šç•Œæ¢ä»¶

```python
def test_é‚Šç•Œæ¢ä»¶(self):
    # æ¸¬è©¦ç©ºå­—ä¸²
    # æ¸¬è©¦æ¥µå¤§å€¼
    # æ¸¬è©¦æ¥µå°å€¼
    # æ¸¬è©¦ç‰¹æ®Šå­—å…ƒ
```

---

## é€²éšï¼šæ•´åˆæ¸¬è©¦ vs å–®å…ƒæ¸¬è©¦

| æ¸¬è©¦é¡å‹ | ç¯„åœ | é€Ÿåº¦ | é©ç”¨æ™‚æ©Ÿ |
|---------|------|------|---------|
| **å–®å…ƒæ¸¬è©¦** | å–®ä¸€æ¨¡çµ„ | å¿«ï¼ˆç§’ç´šï¼‰ | é–‹ç™¼æ™‚é »ç¹åŸ·è¡Œ |
| **æ•´åˆæ¸¬è©¦** | å¤šå€‹æ¨¡çµ„ | æ…¢ï¼ˆåˆ†é˜ç´šï¼‰ | ä¸Šç·šå‰åŸ·è¡Œ |
| **ç«¯å°ç«¯æ¸¬è©¦** | å®Œæ•´æµç¨‹ | å¾ˆæ…¢ | é‡å¤§æ›´æ–°å‰ |

**å»ºè­°**ï¼šå¤šå¯«å–®å…ƒæ¸¬è©¦ï¼Œå°‘é‡æ•´åˆæ¸¬è©¦ã€‚

---

## ç¸½çµ

âœ… æ¨¡çµ„ç¨ç«‹æ¸¬è©¦è®“é–‹ç™¼æ›´å¿«é€Ÿã€æ›´å¯é   
âœ… æ¸¬è©¦å³æ–‡ä»¶ï¼Œçœ‹æ¸¬è©¦å°±çŸ¥é“åŠŸèƒ½æ€éº¼ç”¨  
âœ… ä¿®æ”¹ç¨‹å¼ç¢¼å‰å…ˆå¯«æ¸¬è©¦ï¼Œç¢ºä¿ä¸æœƒç ´å£åŠŸèƒ½  
âœ… æ¸¬è©¦å¤±æ•—æ™‚ï¼Œèƒ½å¿«é€Ÿå®šä½å•é¡Œ  

**è¨˜ä½**ï¼šå¯«æ¸¬è©¦çš„æ™‚é–“ < é™¤éŒ¯çš„æ™‚é–“ï¼
